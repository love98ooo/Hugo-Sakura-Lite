{{ define "main" }}
  <div class="content-card">
    <div class="search-box">
      <svg class="search-box__icon" viewBox="0 0 24 24" width="20" height="20">
        <path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
      <input 
        type="text" 
        id="searchInput" 
        class="search-box__input" 
        placeholder="{{ .Params.placeholder | default `搜索文章...` }}"
        autofocus
        autocomplete="off"
      >
      <button class="search-box__clear" id="searchClear" type="button" aria-label="清除">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    
    <div id="searchResults" class="search-results">
      <p class="search-results__hint">输入关键词开始搜索...</p>
    </div>
  </div>

<script>
(function() {
  'use strict';
  
  let searchIndex = null;
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  const searchClear = document.getElementById('searchClear');
  
  async function loadSearchIndex() {
    if (searchIndex) return searchIndex;
    try {
      const response = await fetch('{{ `/index.json` | relURL }}');
      searchIndex = await response.json();
      return searchIndex;
    } catch (error) {
      console.error('Failed to load search index:', error);
      return [];
    }
  }
  
  function performSearch(query) {
    if (!query || query.length < 2) {
      searchResults.innerHTML = '<p class="search-results__hint">输入关键词开始搜索...</p>';
      return;
    }
    
    const queryLower = query.toLowerCase();
    const results = searchIndex.filter(item => {
      const title = (item.title || '').toLowerCase();
      const content = (item.content || '').toLowerCase();
      const tags = (item.tags || []).join(' ').toLowerCase();
      const categories = (item.categories || []).join(' ').toLowerCase();
      return title.includes(queryLower) || content.includes(queryLower) || tags.includes(queryLower) || categories.includes(queryLower);
    });
    
    displayResults(results, query);
  }
  
  function displayResults(results, query) {
    if (results.length === 0) {
      searchResults.innerHTML = '<div class="search-results__empty"><p>没有找到相关文章</p></div>';
      return;
    }
    
    const html = results.map(item => {
      const title = highlightText(item.title || 'Untitled', query);
      const snippet = getSnippet(item.content || '', query);
      const date = item.date ? new Date(item.date).toLocaleDateString('zh-CN') : '';
      
      return `
        <article class="search-result-item">
          <h3 class="search-result-item__title"><a href="${item.permalink}">${title}</a></h3>
          <p class="search-result-item__snippet">${snippet}</p>
          <div class="search-result-item__meta">
            ${date ? `<time>${date}</time>` : ''}
            ${item.tags && item.tags.length ? `<span class="search-result-item__tags">${item.tags.slice(0, 3).map(t => '#' + t).join(' ')}</span>` : ''}
          </div>
        </article>
      `;
    }).join('');
    
    searchResults.innerHTML = `<div class="search-results__count">找到 ${results.length} 篇相关文章</div><div class="search-results__list">${html}</div>`;
  }
  
  function highlightText(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
  }
  
  function getSnippet(content, query) {
    const maxLength = 150;
    const queryLower = query.toLowerCase();
    const contentLower = content.toLowerCase();
    const index = contentLower.indexOf(queryLower);
    
    if (index === -1) {
      return content.slice(0, maxLength) + (content.length > maxLength ? '...' : '');
    }
    
    const start = Math.max(0, index - 50);
    const end = Math.min(content.length, index + query.length + 100);
    let snippet = content.slice(start, end);
    if (start > 0) snippet = '...' + snippet;
    if (end < content.length) snippet = snippet + '...';
    return highlightText(snippet, query);
  }
  
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }
  
  async function init() {
    await loadSearchIndex();
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');
    if (query) {
      searchInput.value = query;
      performSearch(query);
    }
    
    searchInput.addEventListener('input', debounce(function() {
      performSearch(this.value);
    }, 300));
    
    searchClear.addEventListener('click', function() {
      searchInput.value = '';
      searchInput.focus();
      searchResults.innerHTML = '<p class="search-results__hint">输入关键词开始搜索...</p>';
    });
  }
  
  init();
})();
</script>
{{ end }}
